<!DOCTYPE html>
<html  lang="zh-CN" >
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <title>c++ addons | keyboard3的博客</title>
    <meta name="description" content="Nodejs v15 c++ addons C++ Addons(插件)插件是由 C++ 编写的动态链接共享对象。 require() 可以将插件加载为普通的 Node.js 模块。插件提供了 Js 和 C&#x2F;C++ 库之间的接口。 实现插件有 3 种选择: Node-API, nan, 或者直接使用内部 V8、libuv 和 Node.js 库。除非要访问 Node-API 未暴露出的功能，否则请">
<meta property="og:type" content="article">
<meta property="og:title" content="c++ addons">
<meta property="og:url" content="https://keyboard3.github.io/nodejs-addons/index.html">
<meta property="og:site_name" content="keyboard3的博客">
<meta property="og:description" content="Nodejs v15 c++ addons C++ Addons(插件)插件是由 C++ 编写的动态链接共享对象。 require() 可以将插件加载为普通的 Node.js 模块。插件提供了 Js 和 C&#x2F;C++ 库之间的接口。 实现插件有 3 种选择: Node-API, nan, 或者直接使用内部 V8、libuv 和 Node.js 库。除非要访问 Node-API 未暴露出的功能，否则请">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-04-05T02:47:26.000Z">
<meta property="article:modified_time" content="2022-04-05T14:00:47.020Z">
<meta property="article:author" content="keyboard3">
<meta property="article:tag" content="翻译">
<meta property="article:tag" content="nodejs">
<meta property="article:tag" content="c++">
<meta name="twitter:card" content="summary">

    <link rel="alternate" type="application/atom+xml" href="/blog/atom.xml">
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">

    
<link rel="stylesheet" href="/blog/css/common.min.css">



    
        <link href="//cdn.jsdelivr.net/npm/katex@0.9.0/dist/katex.min.css" rel="stylesheet">
    
    
    
    
        <link href="//cdn.jsdelivr.net/npm/lightgallery.js@1.1.3/dist/css/lightgallery.min.css" rel="stylesheet">
    
    
    
<link rel="stylesheet" href="/blog/css/iconfont.min.css">

    
<meta name="generator" content="Hexo 4.2.0"><link rel="stylesheet" href="/blog/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/blog/css/prism-line-numbers.css" type="text/css"></head>

    <body>
        <header class="header header-fixture">
    <div class="profile-search-wrap flex sm:block">
        
        
        <div class="profile sm:text-center md:px-1 lg:px-3 sm:pb-4 sm:pt-6">
            <a id="avatar" role="link" href="https://github.com/keyboard3" class="inline-block lg:w-16 lg:h-16 w-8 h-8 m-2" target="_blank" rel="noopener" rel="noreferrer" >
                <img src="https://www.gravatar.com/avatar/5a65c2880a8f2804b5af3dc39819bdf1?s=128" class="rounded-full" alt="avatar">
            </a>
            <h2 id="name" class="hidden lg:block">keyboard3</h2>
            <h3 id="title" class="hidden lg:block">单身男青年</h3>
            
            <small id="location" class="hidden lg:block">
                <i class="iconfont icon-map-icon"></i>
                home
            </small>
            
        </div>
        
        
<div class="search flex-1 flex lg:inline-block sm:hidden lg:px-4 lg:mt-2 lg:mb-4 lg:w-full">
    <form id="search-form" class="my-auto flex-1 lg:border lg:border-solid lg:border-gray-200">
        <div class="input-group table bg-gray-100 lg:bg-white w-full">
            <input id="search-input" type="text" placeholder="搜索" class="inline-block w-full bg-gray-100 lg:bg-white">
            <span class="table-cell">
                <button name="search tigger button" disabled>
                    <i class="iconfont icon-search m-2"></i>
                </button>
            </span>
        </div>
    </form>
        
<div id="content-json" data-placeholder="搜索" class="invisible hidden">/content.json</div>
<script id="search-teamplate" type="text/html" data-path="/blog/content.json">
    <div>
        <div class="search-header bg-gray-400">
            <input id="actual-search-input" model="keyword" ref="input" class="inline-block w-full h-10 px-2 py-1" placeholder="搜索" type="text">
        </div>
        <div class="search-result bg-gray-200">
            {{#each searchPosts}}
            <a href="/{{ path }}" class="result-item block px-2 pb-3 mb-1 pt-1 hover:bg-indigo-100">
                <i class="iconfont icon-file"></i>
                <h1 class="result-title inline font-medium text-lg">{{ title }}</h1>
                <p class="result-content text-gray-600 text-sm">{{{ text }}}</p>
            </a>
            {{/each}}
        </div>
    </div>
</script>

</div>


        <button name="menu toogle button" id="menu-toggle-btn" class="block sm:hidden p-3" role="button" aria-expanded="false">
            <i class="iconfont icon-hamburger"></i>
        </button>
    </div>
    <nav id="menu-nav" class="hidden sm:flex flex-col">
        
        
            <div class="menu-item menu-home" role="menuitem">
                <a href="/blog/.">
                    <i class="iconfont icon-home" aria-hidden="true"></i>
                    <span class="menu-title">首页</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-archives" role="menuitem">
                <a href="/blog/archives">
                    <i class="iconfont icon-archive" aria-hidden="true"></i>
                    <span class="menu-title">归档</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-repository" role="menuitem">
                <a href="/blog/repository">
                    <i class="iconfont icon-project" aria-hidden="true"></i>
                    <span class="menu-title">项目</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-about" role="menuitem">
                <a href="/blog/about">
                    <i class="iconfont icon-cup" aria-hidden="true"></i>
                    <span class="menu-title">关于</span>
                </a>
            </div>
        
        
<div class="social-links flex sm:flex-col lg:hidden mt-5">
    
        <span class="social-item text-center">
            <a href="https://github.com/keyboard3" target="_blank" rel="noopener">
                <i class="iconfont social-icon icon-github"></i>
                <span class="menu-title hidden lg:inline">menu.github</span>
            </a>
        </span>
    
        <span class="social-item text-center">
            <a href="/blog/atom.xml">
                <i class="iconfont social-icon icon-rss"></i>
                <span class="menu-title hidden lg:inline">menu.rss</span>
            </a>
        </span>
    
</div>


    </nav>
</header>

        <section class="main-section">
            
    <main class="flex-1 px-4 py-14 md:px-5 lg:px-8 lg:py-4 relative min-h-screen">
    

    <article class="content article article-archives article-type-list" itemscope="">
        <header class="article-header">
            
    
        <h1 class="article-title text-lg" itemprop="name">
            c++ addons
        </h1>
    



            <p class="article-meta mb-3 text-xs">
                <span class="article-date">
    <i class="iconfont icon-calendar-check"></i>
	<a href="/blog/nodejs-addons/" class="article-date">
	  <time datetime="2022-04-05T02:47:26.000Z" itemprop="datePublished">4月 5</time>
	</a>
</span>

                

                
    <span class="article-tags">
    <i class="iconfont icon-tag"></i>
    <a class="article-tag-link" href="/blog/tags/c/" rel="tag">c++</a>, <a class="article-tag-link" href="/blog/tags/nodejs/" rel="tag">nodejs</a>, <a class="article-tag-link" href="/blog/tags/%E7%BF%BB%E8%AF%91/" rel="tag">翻译</a>
  </span>


                <span class="_partial/post-comment"><i class="icon icon-comment"></i>
                    <a href="/blog/nodejs-addons/#comments" class="article-comment-link">
                        评论
                    </a>
                </span>
                
    
        <span class="post-wordcount" itemprop="wordCount">字数统计: 6.6k(字)</span>
    
    
        <span class="post-readcount" itemprop="timeRequired">阅读时长: 30(分)</span>
    


            </p>
        </header>
        <div class="marked-body article-body">
            <p><a href="https://nodejs.org/docs/latest-v15.x/api/addons.html" target="_blank" rel="noopener">Nodejs v15 c++ addons</a></p>
<h1 id="C-Addons-插件"><a href="#C-Addons-插件" class="headerlink" title="C++ Addons(插件)"></a>C++ Addons(插件)</h1><p>插件是由 C++ 编写的动态链接共享对象。 require() 可以将插件加载为普通的 Node.js 模块。插件提供了 Js 和 C/C++ 库之间的接口。</p>
<p>实现插件有 3 种选择: Node-API, nan, 或者直接使用内部 V8、libuv 和 Node.js 库。除非要访问 Node-API 未暴露出的功能，否则请使用 Node-API。 有关 Node-API 更多信息请参考 <a href="https://nodejs.org/docs/latest-v15.x/api/n-api.html" target="_blank" rel="noopener">Node-API 的 C/C++ 插件</a>。</p>
<p>不使用 Node-API 时，实现插件很复杂，涉及到几个组件和 API 的知识：</p>
<ul>
<li>V8：Node.js 用于提供 JavaScript 实现的 C++ 库。 V8 提供了创建对象、调用函数等的机制。V8 的 API 主要记录在 v8.h 头文件（Node.js 源代码树中的 deps/v8/include/v8.h）中，该文件也可以<a href="https://v8docs.nodesource.com/" target="_blank" rel="noopener">在线</a>获得。</li>
<li><a href="https://github.com/libuv/libuv" target="_blank" rel="noopener">libuv</a>: 实现 Node.js 事件循环、工作线程和平台的所有异步行为的 C 库。它还用作跨平台抽象库，为所有主要操作系统提供简单的、类似 POSIX 的访问，以访问许多常见的系统任务，例如与文件系统、套接字、计时器和系统事件交互。 libuv 还为需要超越标准事件循环的更复杂的异步插件提供类似于 POSIX 线程的线程抽象。插件作者应避免使用 I/O 或其他时间密集型任务阻塞事件循环，方法是通过 libuv 将工作卸载到非阻塞系统操作、工作线程或自定义使用 libuv 线程。</li>
<li>内部 Node.js 库。 Node.js 本身导出了插件可以使用的 C++ API，其中最重要的是 node::ObjectWrap 类。</li>
<li>Node.js 包括其他静态链接库，包括 OpenSSL。这些其他库位于 Node.js 源代码树的 <code>deps/</code> 目录中。只有 libuv、OpenSSL、V8 和 zlib 符号被 Node.js 有目的地重新导出，并且可以被插件在不同程度上使用。有关更多信息，请参阅<a href="https://nodejs.org/docs/latest-v15.x/api/addons.html#addons_linking_to_libraries_included_with_node_js" target="_blank" rel="noopener">链接到包含在 Node.js 中的库</a>。</li>
</ul>
<p>以下所有示例均可<a href="https://github.com/nodejs/node-addon-examples" target="_blank" rel="noopener">下载</a>，并可用作插件的起点。</p>
<h2 id="Hello-world"><a href="#Hello-world" class="headerlink" title="Hello world"></a>Hello world</h2><p>这个“Hello world”示例是一个简单的插件，用 C++ 编写，相当于以下 JavaScript 代码：</p>
<pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>hello <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"world"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>首先，创建文件 hello.cc：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// hello.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h></span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Isolate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>String<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Value<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">Method</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>
      isolate<span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Initialize</span><span class="token punctuation">(</span>Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">NODE_SET_METHOD</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">,</span> Method<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE</span><span class="token punctuation">(</span>NODE_GYP_MODULE_NAME<span class="token punctuation">,</span> Initialize<span class="token punctuation">)</span>

<span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// namespace demo</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>所有 Node.js 插件都必须按照以下模式导出初始化函数：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">Initialize</span><span class="token punctuation">(</span>Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> exports<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">NODE_MODULE</span><span class="token punctuation">(</span>NODE_GYP_MODULE_NAME<span class="token punctuation">,</span> Initialize<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>NODE_MODULE 后没有分号，因为它不是函数（参见 node.h）。</p>
<p>module_name 必须与最终二进制文件的文件名匹配（不包括 .node 后缀）。</p>
<p>那么，在 hello.cc 示例中，初始化函数为 Initialize，插件模块名称为 addon。</p>
<p>当使用 node-gyp 构建插件时，使用宏 NODE_GYP_MODULE_NAME 作为 NODE_MODULE() 的第一个参数将确保最终二进制文件的名称将传递给 NODE_MODULE()。</p>
<h3 id="上下文感知插件"><a href="#上下文感知插件" class="headerlink" title="上下文感知插件"></a>上下文感知插件</h3><p>在某些环境中，可能需要在多个上下文中多次加载 Node.js 插件。例如，Electron 运行时在单个进程中运行多个 Node.js 实例。每个实例都有自己的 require() 缓存，因此每个实例在通过 require() 加载时都需要一个 Native 插件才能正常运行。这意味着插件必须支持多个初始化。</p>
<p>可以使用宏 NODE_MODULE_INITIALIZER 构建上下文感知插件，该宏扩展为 Node.js 在加载插件时期望找到的函数的名称。因此，可以像以下示例一样初始化插件：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">using</span> <span class="token keyword">namespace</span> v8<span class="token punctuation">;</span>

<span class="token keyword">extern</span> <span class="token string">"C"</span> NODE_MODULE_EXPORT <span class="token keyword">void</span>
<span class="token function">NODE_MODULE_INITIALIZER</span><span class="token punctuation">(</span>Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> exports<span class="token punctuation">,</span>
                        Local<span class="token operator">&lt;</span>Value<span class="token operator">></span> module<span class="token punctuation">,</span>
                        Local<span class="token operator">&lt;</span>Context<span class="token operator">></span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">/* Perform addon initialization steps here. */</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>另一种选择是使用宏 NODE_MODULE_INIT()，它还将构建一个上下文感知插件。与 NODE_MODULE() 不同，NODE_MODULE() 用于围绕给定的插件初始化函数构造插件，NODE_MODULE_INIT() 用作此类初始化程序的声明，后跟函数体。</p>
<p>在调用 NODE_MODULE_INIT() 之后，可以在函数体内使用以下三个变量：</p>
<ul>
<li><code>Local&lt;Object&gt; exports</code></li>
<li><code>Local&lt;Value&gt; module</code></li>
<li><code>Local&lt;Context&gt; context</code></li>
</ul>
<p>构建上下文感知插件的选择带有仔细管理全局静态数据的责任。由于插件可能会被多次加载，甚至可能来自不同的线程，因此存储在插件中的任何全局静态数据都必须得到适当的保护，并且不得包含对 JavaScript 对象的任何持久引用。这样做的原因是 JavaScript 对象仅在一个上下文中有效，并且当从错误的上下文或从与创建它们的线程不同的线程访问时，可能会导致崩溃。</p>
<p>通过执行以下步骤，可以构建上下文感知插件以避免全局静态数据：</p>
<ul>
<li>定义一个类，该类将保存每个插件实例的数据并具有表单的静态成员</li>
</ul>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">DeleteInstance</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// Cast `data` to an instance of the class and delete it.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li>在插件初始化器中堆分配此类的一个实例。这可以使用 new 关键字来完成。</li>
<li>调用 node::AddEnvironmentCleanupHook()，将上面创建的实例和指向 DeleteInstance() 的指针传递给它。这将确保在环境被拆除时删除实例。</li>
<li>将类的实例存储在 v8::External 中，并且</li>
<li>将 v8::External 传递给所有暴露给 JavaScript 的方法，方法是将其传递给 v8::FunctionTemplate::New() 或 v8::Function::New() 以创建 Native 支持的 JavaScript 函数。 v8::FunctionTemplate::New() 或 v8::Function::New() 的第三个参数接受 v8::External 并使用 v8::FunctionCallbackInfo::Data() 方法使其在Native 回调中可用。</li>
</ul>
<p>这将确保每个插件实例的数据到达每个可以从 JavaScript 调用的绑定。每个插件实例的数据也必须传递到插件可能创建的任何异步回调中。</p>
<p>以下示例说明了上下文感知插件的实现：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h></span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> v8<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">AddonData</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">explicit</span> <span class="token function">AddonData</span><span class="token punctuation">(</span>Isolate<span class="token operator">*</span> isolate<span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token function">call_count</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 确保在环境清理时删除每个插件实例的数据。</span>
    node<span class="token operator">::</span><span class="token function">AddEnvironmentCleanupHook</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> DeleteInstance<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 每个插件数据。</span>
  <span class="token keyword">int</span> call_count<span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">DeleteInstance</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>AddonData<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Method</span><span class="token punctuation">(</span><span class="token keyword">const</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 检索每个插件实例的数据。</span>
  AddonData<span class="token operator">*</span> data <span class="token operator">=</span>
      <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>AddonData<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>As<span class="token operator">&lt;</span>External<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  data<span class="token operator">-</span><span class="token operator">></span>call_count<span class="token operator">++</span><span class="token punctuation">;</span>
  info<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>data<span class="token operator">-</span><span class="token operator">></span>call_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 将此插件初始化为上下文感知。</span>
<span class="token function">NODE_MODULE_INIT</span><span class="token punctuation">(</span><span class="token comment" spellcheck="true">/* exports, module, context */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> context<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 为这个插件实例创建一个新的 `AddonData` 实例，并将其生命周期与 Node.js 环境的生命周期联系起来</span>
  AddonData<span class="token operator">*</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">AddonData</span><span class="token punctuation">(</span>isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 将数据包装在 `v8::External` 中，以便我们可以将其传递给我们公开的方法</span>
  Local<span class="token operator">&lt;</span>External<span class="token operator">></span> external <span class="token operator">=</span> External<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 将 `Method` 方法暴露给 JavaScript，并通过将 `external` </span>
  <span class="token comment" spellcheck="true">// 作为第三个参数传递给 `FunctionTemplate` 构造函数</span>
  <span class="token comment" spellcheck="true">// 来确保它接收我们在上面创建的每个插件实例的数据。</span>
  exports<span class="token operator">-</span><span class="token operator">></span><span class="token function">Set</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span>
               String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> <span class="token string">"method"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               FunctionTemplate<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> Method<span class="token punctuation">,</span> external<span class="token punctuation">)</span>
                  <span class="token operator">-</span><span class="token operator">></span><span class="token function">GetFunction</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FromJust</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="支持-Worker"><a href="#支持-Worker" class="headerlink" title="支持 Worker"></a>支持 Worker</h3><p>History</p>
<table>
<thead>
<tr>
<th>Version</th>
<th>Changes</th>
</tr>
</thead>
<tbody><tr>
<td>v14.8.0,v12.19.0</td>
<td>清理 hooks 现在可能是异步的。</td>
</tr>
</tbody></table>
<p>为了从多个 Node.js 环境（例如主线程和工作线程）加载，插件需要：</p>
<ul>
<li>成为 Node-API 插件</li>
<li>如上所述使用 NODE_MODULE_INIT() 声明为上下文感知</li>
</ul>
<p>为了支持 <a href="https://nodejs.org/docs/latest-v15.x/api/worker_threads.html#worker_threads_class_worker" target="_blank" rel="noopener">Worker</a> 线程，插件需要在存在此类线程时清理它们可能分配的任何资源。这可以通过使用 AddEnvironmentCleanupHook() 函数来实现：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">AddEnvironmentCleanupHook</span><span class="token punctuation">(</span>v8<span class="token operator">::</span>Isolate<span class="token operator">*</span> isolate<span class="token punctuation">,</span>
                               <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>fun<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">,</span>
                               <span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这个函数添加了一个 hook，它将在给定的 Node.js 实例关闭之前运行。如有必要，可以使用具有相同签名的 RemoveEnvironmentCleanupHook() 在运行此类 hook 之前将其删除。回调按后进先出的顺序运行。</p>
<p>如有必要，还有一对 AddEnvironmentCleanupHook() 和 RemoveEnvironmentCleanupHook() 重载，其中清理 hook 采用回调函数。这可用于关闭异步资源，例如插件注册的任何 libuv 句柄。</p>
<p>以下 addon.cc 使用 AddEnvironmentCleanupHook：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// addon.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>

<span class="token keyword">using</span> node<span class="token operator">::</span>AddEnvironmentCleanupHook<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>HandleScope<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Isolate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 注意：在实际应用中，不要依赖静态/全局数据。</span>
<span class="token keyword">static</span> <span class="token keyword">char</span> cookie<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"yum yum"</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> cleanup_cb1_called <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> cleanup_cb2_called <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">cleanup_cb1</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>Isolate<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  HandleScope <span class="token function">scope</span><span class="token punctuation">(</span>isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> obj <span class="token operator">=</span> Object<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// assert VM is still alive</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>obj<span class="token operator">-</span><span class="token operator">></span><span class="token function">IsObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cleanup_cb1_called<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">cleanup_cb2</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>arg <span class="token operator">==</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cleanup_cb2_called<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sanity_check</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>cleanup_cb1_called <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>cleanup_cb2_called <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 将此插件初始化为上下文感知。</span>
<span class="token function">NODE_MODULE_INIT</span><span class="token punctuation">(</span><span class="token comment" spellcheck="true">/* exports, module, context */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> context<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">AddEnvironmentCleanupHook</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> sanity_check<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AddEnvironmentCleanupHook</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> cleanup_cb2<span class="token punctuation">,</span> cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AddEnvironmentCleanupHook</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> cleanup_cb1<span class="token punctuation">,</span> isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过运行在 JavaScript 中进行测试：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// test.js</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h3><p>编写源代码后，必须将其编译到二进制 addon.node 文件中。为此，请在项目的顶层创建一个名为 binding.gyp 的文件，该文件使用类似 JSON 的格式描述模块的构建配置。该文件由 node-gyp 使用，这是一个专门为编译 Node.js 插件而编写的工具。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token punctuation">{</span>
  <span class="token string">"targets"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"target_name"</span><span class="token operator">:</span> <span class="token string">"addon"</span><span class="token punctuation">,</span>
      <span class="token string">"sources"</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">"hello.cc"</span> <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>node-gyp 实用程序的一个版本作为 npm 的一部分与 Node.js 捆绑和分发。此版本不直接供开发人员使用，仅用于支持使用 npm install 命令编译和安装插件的能力。希望直接使用 node-gyp 的开发人员可以使用命令 npm install -g node-gyp 安装它。有关更多信息，包括特定于平台的要求，请参阅 <a href="https://github.com/nodejs/node-gyp#installation" target="_blank" rel="noopener">node-gyp 安装说明</a>。</p>
<p>创建 binding.gyp 文件后，使用 node-gyp configure 为当前平台生成适当的项目构建文件。这将在 build/ 目录中生成 Makefile（在 Unix 平台上）或 vcxproj 文件（在 Windows 上）。</p>
<p>接下来，调用 node-gyp build 命令来生成编译好的 addon.node 文件。这将被放入 <code>build/Release/</code> 目录中。</p>
<p>当使用 npm install 安装 Node.js 插件时，npm 使用它自己的 node-gyp 捆绑版本来执行同样的一组操作，根据需要为用户的平台生成插件的编译版本。</p>
<p>构建完成后，可以通过将 require() 指向构建的 addon.node 模块，在 Node.js 中使用二进制插件：</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// hello.js</span>
<span class="token keyword">const</span> addon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>addon<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Prints: 'world'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为编译后的插件二进制文件的确切路径可能会因编译方式而异（即有时它可能位于 <code>./build/Debug/</code> 中），所以插件可以使用 <a href="https://github.com/TooTallNate/node-bindings" target="_blank" rel="noopener">bindings</a> 包来加载编译后的模块。</p>
<p>虽然 bindings 包实现在如何定位插件模块方面更加复杂，但它本质上是使用类似于以下的 try…catch 模式：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/Release/addon.node'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/Debug/addon.node'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="链接到-Node-js-中包含的库"><a href="#链接到-Node-js-中包含的库" class="headerlink" title="链接到 Node.js 中包含的库"></a>链接到 Node.js 中包含的库</h3><p>Node.js 使用静态链接库，例如 V8、libuv 和 OpenSSL。所有插件都需要链接到 V8，也可以链接到任何其他依赖项。通常，这就像包含适当的#include &lt;…&gt; 语句（例如#include &lt;v8.h&gt;）一样简单，node-gyp 将自动定位适当的标头。但是，有一些注意事项需要注意：</p>
<ul>
<li>当 node-gyp 运行时，它将检测 Node.js 的特定发行版本并下载完整的源代码压缩包或仅下载标头。如果下载了完整的源代码，插件将拥有对全套 Node.js 依赖项的完全访问权限。但是，如果仅下载 Node.js 标头，则只有 Node.js 导出的符号可用。</li>
<li>node-gyp 可以使用指向本地 Node.js 源图像的 –nodedir 标志运行。使用此选项，插件将有权访问完整的依赖项集。</li>
</ul>
<h3 id="使用-require-加载插件"><a href="#使用-require-加载插件" class="headerlink" title="使用 require() 加载插件"></a>使用 require() 加载插件</h3><p>已编译插件二进制文件的文件扩展名为 .node（与 .dll 或 .so 相对）。编写 require() 函数以查找具有 .node 文件扩展名的文件并将其初始化为动态链接库。</p>
<p>调用 <a href="https://nodejs.org/docs/latest-v15.x/api/modules.html#modules_require_id" target="_blank" rel="noopener">require()</a> 时，通常可以省略 .node 扩展名，Node.js 仍然会找到并初始化插件。然而，需要注意的是，Node.js 将首先尝试定位和加载碰巧共享相同基本名称的模块或 JavaScript 文件。例如，如果在与二进制 addon.node 相同的目录中有一个文件 addon.js，则 <a href="https://nodejs.org/docs/latest-v15.x/api/modules.html#modules_require_id" target="_blank" rel="noopener">require(‘addon’)</a> 将优先加载 addon.js 文件并加载它。</p>
<h3 id="Node-js-的-Native-抽象"><a href="#Node-js-的-Native-抽象" class="headerlink" title="Node.js 的 Native 抽象"></a>Node.js 的 Native 抽象</h3><p>本文档中说明的每个示例都直接使用 Node.js 和 V8 API 来实现插件。 V8 API 可以并且已经从一个 V8 版本到下一个版本（以及一个主要的 Node.js 版本到下一个版本）发生了巨大变化。随着每次更改，插件可能需要更新和重新编译才能继续运行。 Node.js 发布计划旨在最大限度地减少此类更改的频率和影响，但 Node.js 几乎无法确保 V8 API 的稳定性。</p>
<p><a href="https://github.com/nodejs/nan" target="_blank" rel="noopener">Node.js 的 Native Abstractions</a>（或 nan） 提供了一组工具，建议插件开发人员使用这些工具来保持 V8 和 Node.js 过去和未来版本之间的兼容性。有关如何使用它的说明，请参阅 <a href="https://github.com/nodejs/nan/tree/HEAD/examples/" target="_blank" rel="noopener">nan 示例</a>。</p>
<h2 id="Node-API"><a href="#Node-API" class="headerlink" title="Node-API"></a>Node-API</h2><p>Node-API 是用于构建 Native 插件的 API。它独立于底层 JavaScript 运行时（例如 V8），并作为 Node.js 本身的一部分进行维护。此 API 将是跨 Node.js 版本稳定的应用程序二进制接口 (ABI)。它旨在将插件与底层 JavaScript 引擎中的更改隔离开来，并允许为一个版本编译的模块在更高版本的 Node.js 上运行而无需重新编译。插件使用本文档中概述的相同方法/工具（node-gyp 等）构建/打包。唯一的区别是Native 代码使用的 API 集。不使用 Node.js API 的 V8 或 <a href="https://github.com/nodejs/nan" target="_blank" rel="noopener">Native Abstractions</a>，而是使用 Node-API 中可用的函数。</p>
<p>创建和维护一个受益于 Node-API 提供的 ABI 稳定性的插件会带来某些<a href="https://nodejs.org/docs/latest-v15.x/api/n-api.html#n_api_implications_of_abi_stability" target="_blank" rel="noopener">实现方面的考虑</a>。</p>
<p>要在上面的“Hello world”示例中使用 Node-API，请将 hello.cc 的内容替换为以下内容。所有其他指令保持不变。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// hello.cc using Node-API</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node_api.h></span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

napi_value <span class="token function">Method</span><span class="token punctuation">(</span>napi_env env<span class="token punctuation">,</span> napi_callback_info args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  napi_value greeting<span class="token punctuation">;</span>
  napi_status status<span class="token punctuation">;</span>

  status <span class="token operator">=</span> <span class="token function">napi_create_string_utf8</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">,</span> NAPI_AUTO_LENGTH<span class="token punctuation">,</span> <span class="token operator">&amp;</span>greeting<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> napi_ok<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> greeting<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

napi_value <span class="token function">init</span><span class="token punctuation">(</span>napi_env env<span class="token punctuation">,</span> napi_value exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  napi_status status<span class="token punctuation">;</span>
  napi_value fn<span class="token punctuation">;</span>

  status <span class="token operator">=</span> <span class="token function">napi_create_function</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Method<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> napi_ok<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

  status <span class="token operator">=</span> <span class="token function">napi_set_named_property</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> napi_ok<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> exports<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NAPI_MODULE</span><span class="token punctuation">(</span>NODE_GYP_MODULE_NAME<span class="token punctuation">,</span> init<span class="token punctuation">)</span>

<span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// namespace demo</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可用的功能以及如何使用它们都记录在带有 <a href="https://nodejs.org/docs/latest-v15.x/api/n-api.html" target="_blank" rel="noopener">Node-API 的 C/C++ 插件</a>中。</p>
<h2 id="插件示例"><a href="#插件示例" class="headerlink" title="插件示例"></a>插件示例</h2><p>以下是一些旨在帮助开发人员入门的示例插件。这些示例使用 V8 API。有关各种 V8 调用的帮助，请参阅在线 V8 参考，并参阅 V8 的嵌入器指南，以了解使用的几个概念，例如句柄、作用域、函数模板等。</p>
<p>这些示例中的每一个都使用以下 binding.gyp 文件：</p>
<pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"targets"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"target_name"</span><span class="token operator">:</span> <span class="token string">"addon"</span><span class="token punctuation">,</span>
      <span class="token property">"sources"</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">"addon.cc"</span> <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果有多个 .cc 文件，只需将附加文件名添加到源数组：</p>
<pre class="line-numbers language-json"><code class="language-json"><span class="token property">"sources"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"addon.cc"</span><span class="token punctuation">,</span> <span class="token string">"myexample.cc"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>一旦 binding.gyp 文件准备好，就可以使用 node-gyp 配置和构建示例插件：</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ node-gyp configure build<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="函数参数"><a href="#函数参数" class="headerlink" title="函数参数"></a>函数参数</h3><p>插件通常会暴露可以从 Node.js 中运行的 JavaScript 访问的对象和函数。当从 JavaScript 调用函数时，输入参数和返回值必须映射到 C/C++ 代码和从 C/C++ 代码映射。</p>
<p>以下示例说明了如何读取从 JavaScript 传递的函数参数以及如何返回结果：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// addon.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h></span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">using</span> v8<span class="token operator">::</span>Exception<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Isolate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Number<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>String<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Value<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// This is the implementation of the "add" method</span>
<span class="token comment" spellcheck="true">// Input arguments are passed using the</span>
<span class="token comment" spellcheck="true">// const FunctionCallbackInfo&lt;Value>&amp; args struct</span>
<span class="token keyword">void</span> <span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Check the number of arguments passed.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">Length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Throw an Error that is passed back to JavaScript</span>
    isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">ThrowException</span><span class="token punctuation">(</span>Exception<span class="token operator">::</span><span class="token function">TypeError</span><span class="token punctuation">(</span>
        String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span>
                            <span class="token string">"Wrong number of arguments"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// Check the argument types</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">IsNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">IsNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">ThrowException</span><span class="token punctuation">(</span>Exception<span class="token operator">::</span><span class="token function">TypeError</span><span class="token punctuation">(</span>
        String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span>
                            <span class="token string">"Wrong arguments"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// Perform the operation</span>
  <span class="token keyword">double</span> value <span class="token operator">=</span>
      args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>As<span class="token operator">&lt;</span>Number<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>As<span class="token operator">&lt;</span>Number<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Number<span class="token operator">></span> num <span class="token operator">=</span> Number<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Set the return value (using the passed in</span>
  <span class="token comment" spellcheck="true">// FunctionCallbackInfo&lt;Value>&amp;)</span>
  args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span>Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">NODE_SET_METHOD</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">"add"</span><span class="token punctuation">,</span> Add<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE</span><span class="token punctuation">(</span>NODE_GYP_MODULE_NAME<span class="token punctuation">,</span> Init<span class="token punctuation">)</span>

<span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// namespace demo</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>编译后，可以在 Node.js 中需要和使用示例插件：</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// test.js</span>
<span class="token keyword">const</span> addon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'This should be eight:'</span><span class="token punctuation">,</span> addon<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="回调"><a href="#回调" class="headerlink" title="回调"></a>回调</h3><p>插件中的常见做法是将 JavaScript 函数传递给 C++ 函数并从那里执行它们。以下示例说明了如何调用此类回调：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// addon.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h></span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">using</span> v8<span class="token operator">::</span>Context<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Function<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Isolate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Null<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>String<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Value<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">RunCallback</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Context<span class="token operator">></span> context <span class="token operator">=</span> isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Function<span class="token operator">></span> cb <span class="token operator">=</span> Local<span class="token operator">&lt;</span>Function<span class="token operator">></span><span class="token operator">::</span><span class="token function">Cast</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">unsigned</span> argc <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Value<span class="token operator">></span> argv<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span>
                          <span class="token string">"hello world"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  cb<span class="token operator">-</span><span class="token operator">></span><span class="token function">Call</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token function">Null</span><span class="token punctuation">(</span>isolate<span class="token punctuation">)</span><span class="token punctuation">,</span> argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span>Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> exports<span class="token punctuation">,</span> Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">NODE_SET_METHOD</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token string">"exports"</span><span class="token punctuation">,</span> RunCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE</span><span class="token punctuation">(</span>NODE_GYP_MODULE_NAME<span class="token punctuation">,</span> Init<span class="token punctuation">)</span>

<span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// namespace demo</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此示例使用 Init() 的双参数形式，它接收完整的模块对象作为第二个参数。这允许插件使用单个函数完全覆盖导出，而不是将函数添加为导出的属性。</p>
<p>要对其进行测试，请运行以下 JavaScript：</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// test.js</span>
<span class="token keyword">const</span> addon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">addon</span><span class="token punctuation">(</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Prints: 'hello world'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个例子中，回调函数是同步调用的。</p>
<h3 id="对象工厂"><a href="#对象工厂" class="headerlink" title="对象工厂"></a>对象工厂</h3><p>插件可以从 C++ 函数中创建和返回新对象，如下例所示。创建一个对象并返回一个属性 msg，该属性与传递给 createObject() 的字符串相呼应：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// addon.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h></span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">using</span> v8<span class="token operator">::</span>Context<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Isolate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>String<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Value<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">CreateObject</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Context<span class="token operator">></span> context <span class="token operator">=</span> isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> obj <span class="token operator">=</span> Object<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  obj<span class="token operator">-</span><span class="token operator">></span><span class="token function">Set</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span>
           String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span>
                               <span class="token string">"msg"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">ToString</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">FromJust</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span>Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> exports<span class="token punctuation">,</span> Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">NODE_SET_METHOD</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token string">"exports"</span><span class="token punctuation">,</span> CreateObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE</span><span class="token punctuation">(</span>NODE_GYP_MODULE_NAME<span class="token punctuation">,</span> Init<span class="token punctuation">)</span>

<span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// namespace demo</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 JavaScript 中测试它：</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// test.js</span>
<span class="token keyword">const</span> addon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> obj1 <span class="token operator">=</span> <span class="token function">addon</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> obj2 <span class="token operator">=</span> <span class="token function">addon</span><span class="token punctuation">(</span><span class="token string">'world'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj1<span class="token punctuation">.</span>msg<span class="token punctuation">,</span> obj2<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Prints: 'hello world'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="函数工厂"><a href="#函数工厂" class="headerlink" title="函数工厂"></a>函数工厂</h3><p>另一个常见的场景是创建包装 C++ 函数并将其返回给 JavaScript 的 JavaScript 函数：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// addon.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h></span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">using</span> v8<span class="token operator">::</span>Context<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Function<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionTemplate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Isolate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>String<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Value<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">MyFunction</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>
      isolate<span class="token punctuation">,</span> <span class="token string">"hello world"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">CreateFunction</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  Local<span class="token operator">&lt;</span>Context<span class="token operator">></span> context <span class="token operator">=</span> isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>FunctionTemplate<span class="token operator">></span> tpl <span class="token operator">=</span> FunctionTemplate<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> MyFunction<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Function<span class="token operator">></span> fn <span class="token operator">=</span> tpl<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetFunction</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// omit this to make it anonymous</span>
  fn<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetName</span><span class="token punctuation">(</span>String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>
      isolate<span class="token punctuation">,</span> <span class="token string">"theFunction"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span>Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> exports<span class="token punctuation">,</span> Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">NODE_SET_METHOD</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token string">"exports"</span><span class="token punctuation">,</span> CreateFunction<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE</span><span class="token punctuation">(</span>NODE_GYP_MODULE_NAME<span class="token punctuation">,</span> Init<span class="token punctuation">)</span>

<span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// namespace demo</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>去测试：</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// test.js</span>
<span class="token keyword">const</span> addon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">addon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Prints: 'hello world'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="包装-C-对象"><a href="#包装-C-对象" class="headerlink" title="包装 C++ 对象"></a>包装 C++ 对象</h3><p>也可以以允许使用 JavaScript new 运算符创建新实例的方式包装 C++ 对象/类：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// addon.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"myobject.h"</span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">InitAll</span><span class="token punctuation">(</span>Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  MyObject<span class="token operator">::</span><span class="token function">Init</span><span class="token punctuation">(</span>exports<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE</span><span class="token punctuation">(</span>NODE_GYP_MODULE_NAME<span class="token punctuation">,</span> InitAll<span class="token punctuation">)</span>

<span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// namespace demo</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后，在 myobject.h 中，包装类继承自 node::ObjectWrap：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// myobject.h</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> MYOBJECT_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MYOBJECT_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node_object_wrap.h></span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">class</span> <span class="token class-name">MyObject</span> <span class="token operator">:</span> <span class="token keyword">public</span> node<span class="token operator">::</span>ObjectWrap <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span>v8<span class="token operator">::</span>Local<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Object<span class="token operator">></span> exports<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">explicit</span> <span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token keyword">double</span> value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">~</span><span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token keyword">const</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">PlusOne</span><span class="token punctuation">(</span><span class="token keyword">const</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">double</span> value_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// namespace demo</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 myobject.cc 中，实现要公开的各种方法。下面，通过将 plusOne() 方法添加到构造函数的原型中来公开该方法：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// myobject.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"myobject.h"</span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">using</span> v8<span class="token operator">::</span>Context<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Function<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionTemplate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Isolate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Number<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>ObjectTemplate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>String<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Value<span class="token punctuation">;</span>

MyObject<span class="token operator">::</span><span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token keyword">double</span> value<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">value_</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

MyObject<span class="token operator">::</span><span class="token operator">~</span><span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyObject<span class="token operator">::</span><span class="token function">Init</span><span class="token punctuation">(</span>Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> exports<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Context<span class="token operator">></span> context <span class="token operator">=</span> isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  Local<span class="token operator">&lt;</span>ObjectTemplate<span class="token operator">></span> addon_data_tpl <span class="token operator">=</span> ObjectTemplate<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  addon_data_tpl<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetInternalFieldCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 1 field for the MyObject::New()</span>
  Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> addon_data <span class="token operator">=</span>
      addon_data_tpl<span class="token operator">-</span><span class="token operator">></span><span class="token function">NewInstance</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Prepare constructor template</span>
  Local<span class="token operator">&lt;</span>FunctionTemplate<span class="token operator">></span> tpl <span class="token operator">=</span> FunctionTemplate<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> New<span class="token punctuation">,</span> addon_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  tpl<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetClassName</span><span class="token punctuation">(</span>String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> <span class="token string">"MyObject"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tpl<span class="token operator">-</span><span class="token operator">></span><span class="token function">InstanceTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">SetInternalFieldCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Prototype</span>
  <span class="token function">NODE_SET_PROTOTYPE_METHOD</span><span class="token punctuation">(</span>tpl<span class="token punctuation">,</span> <span class="token string">"plusOne"</span><span class="token punctuation">,</span> PlusOne<span class="token punctuation">)</span><span class="token punctuation">;</span>

  Local<span class="token operator">&lt;</span>Function<span class="token operator">></span> constructor <span class="token operator">=</span> tpl<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetFunction</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  addon_data<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetInternalField</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  exports<span class="token operator">-</span><span class="token operator">></span><span class="token function">Set</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>
      isolate<span class="token punctuation">,</span> <span class="token string">"MyObject"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      constructor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FromJust</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyObject<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Context<span class="token operator">></span> context <span class="token operator">=</span> isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">IsConstructCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Invoked as constructor: `new MyObject(...)`</span>
    <span class="token keyword">double</span> value <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">IsUndefined</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span>
        <span class="token number">0</span> <span class="token operator">:</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">NumberValue</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FromMaybe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MyObject<span class="token operator">*</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">MyObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    obj<span class="token operator">-</span><span class="token operator">></span><span class="token function">Wrap</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">This</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">This</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Invoked as plain function `MyObject(...)`, turn into construct call.</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> argc <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    Local<span class="token operator">&lt;</span>Value<span class="token operator">></span> argv<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    Local<span class="token operator">&lt;</span>Function<span class="token operator">></span> cons <span class="token operator">=</span>
        args<span class="token punctuation">.</span><span class="token function">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>As<span class="token operator">&lt;</span>Object<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">GetInternalField</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>As<span class="token operator">&lt;</span>Function<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> result <span class="token operator">=</span>
        cons<span class="token operator">-</span><span class="token operator">></span><span class="token function">NewInstance</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyObject<span class="token operator">::</span><span class="token function">PlusOne</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  MyObject<span class="token operator">*</span> obj <span class="token operator">=</span> ObjectWrap<span class="token operator">::</span>Unwrap<span class="token operator">&lt;</span>MyObject<span class="token operator">></span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">Holder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  obj<span class="token operator">-</span><span class="token operator">></span>value_ <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>Number<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> obj<span class="token operator">-</span><span class="token operator">></span>value_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// namespace demo</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>要构建此示例，必须将 myobject.cc 文件添加到 binding.gyp：</p>
<pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"targets"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"target_name"</span><span class="token operator">:</span> <span class="token string">"addon"</span><span class="token punctuation">,</span>
      <span class="token property">"sources"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"addon.cc"</span><span class="token punctuation">,</span>
        <span class="token string">"myobject.cc"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试它：</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// test.js</span>
<span class="token keyword">const</span> addon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">addon<span class="token punctuation">.</span>MyObject</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">plusOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Prints: 11</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">plusOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Prints: 12</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">plusOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Prints: 13</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>包装对象的析构函数将在对象被垃圾回收时运行。对于析构函数测试，可以使用命令行标志来强制进行垃圾回收。这些标志由底层 V8 JavaScript 引擎提供。它们可能随时更改或删除。 Node.js 或 V8 没有记录它们，并且它们不应该在测试之外使用。</p>
<h3 id="对象包装工厂"><a href="#对象包装工厂" class="headerlink" title="对象包装工厂"></a>对象包装工厂</h3><p>或者，可以使用工厂模式来避免使用 JavaScript new 运算符显式创建对象实例：</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> obj <span class="token operator">=</span> addon<span class="token punctuation">.</span><span class="token function">createObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// instead of:</span>
<span class="token comment" spellcheck="true">// const obj = new addon.Object();</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>首先，createObject() 方法在 addon.cc 中实现：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// addon.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"myobject.h"</span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Isolate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>String<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Value<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">CreateObject</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  MyObject<span class="token operator">::</span><span class="token function">NewInstance</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">InitAll</span><span class="token punctuation">(</span>Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> exports<span class="token punctuation">,</span> Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  MyObject<span class="token operator">::</span><span class="token function">Init</span><span class="token punctuation">(</span>exports<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">NODE_SET_METHOD</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token string">"exports"</span><span class="token punctuation">,</span> CreateObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE</span><span class="token punctuation">(</span>NODE_GYP_MODULE_NAME<span class="token punctuation">,</span> InitAll<span class="token punctuation">)</span>

<span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// namespace demo</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 myobject.h 中，添加了静态方法 NewInstance() 来处理实例化对象。这个方法代替了在 JavaScript 中使用 new：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// myobject.h</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> MYOBJECT_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MYOBJECT_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node_object_wrap.h></span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">class</span> <span class="token class-name">MyObject</span> <span class="token operator">:</span> <span class="token keyword">public</span> node<span class="token operator">::</span>ObjectWrap <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span>v8<span class="token operator">::</span>Isolate<span class="token operator">*</span> isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">NewInstance</span><span class="token punctuation">(</span><span class="token keyword">const</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">explicit</span> <span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token keyword">double</span> value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">~</span><span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token keyword">const</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">PlusOne</span><span class="token punctuation">(</span><span class="token keyword">const</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> v8<span class="token operator">::</span>Global<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Function<span class="token operator">></span> constructor<span class="token punctuation">;</span>
  <span class="token keyword">double</span> value_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// namespace demo</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>myobject.cc 中的实现与前面的示例类似：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// myobject.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"myobject.h"</span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">using</span> node<span class="token operator">::</span>AddEnvironmentCleanupHook<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Context<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Function<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionTemplate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Global<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Isolate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Number<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>String<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Value<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Warning! This is not thread-safe, this addon cannot be used for worker</span>
<span class="token comment" spellcheck="true">// threads.</span>
Global<span class="token operator">&lt;</span>Function<span class="token operator">></span> MyObject<span class="token operator">::</span>constructor<span class="token punctuation">;</span>

MyObject<span class="token operator">::</span><span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token keyword">double</span> value<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">value_</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

MyObject<span class="token operator">::</span><span class="token operator">~</span><span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyObject<span class="token operator">::</span><span class="token function">Init</span><span class="token punctuation">(</span>Isolate<span class="token operator">*</span> isolate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// Prepare constructor template</span>
  Local<span class="token operator">&lt;</span>FunctionTemplate<span class="token operator">></span> tpl <span class="token operator">=</span> FunctionTemplate<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> New<span class="token punctuation">)</span><span class="token punctuation">;</span>
  tpl<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetClassName</span><span class="token punctuation">(</span>String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> <span class="token string">"MyObject"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tpl<span class="token operator">-</span><span class="token operator">></span><span class="token function">InstanceTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">SetInternalFieldCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Prototype</span>
  <span class="token function">NODE_SET_PROTOTYPE_METHOD</span><span class="token punctuation">(</span>tpl<span class="token punctuation">,</span> <span class="token string">"plusOne"</span><span class="token punctuation">,</span> PlusOne<span class="token punctuation">)</span><span class="token punctuation">;</span>

  Local<span class="token operator">&lt;</span>Context<span class="token operator">></span> context <span class="token operator">=</span> isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  constructor<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> tpl<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetFunction</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">AddEnvironmentCleanupHook</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    constructor<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyObject<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Context<span class="token operator">></span> context <span class="token operator">=</span> isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">IsConstructCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Invoked as constructor: `new MyObject(...)`</span>
    <span class="token keyword">double</span> value <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">IsUndefined</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span>
        <span class="token number">0</span> <span class="token operator">:</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">NumberValue</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FromMaybe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MyObject<span class="token operator">*</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">MyObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    obj<span class="token operator">-</span><span class="token operator">></span><span class="token function">Wrap</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">This</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">This</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Invoked as plain function `MyObject(...)`, turn into construct call.</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> argc <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    Local<span class="token operator">&lt;</span>Value<span class="token operator">></span> argv<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    Local<span class="token operator">&lt;</span>Function<span class="token operator">></span> cons <span class="token operator">=</span> Local<span class="token operator">&lt;</span>Function<span class="token operator">></span><span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> instance <span class="token operator">=</span>
        cons<span class="token operator">-</span><span class="token operator">></span><span class="token function">NewInstance</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyObject<span class="token operator">::</span><span class="token function">NewInstance</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token keyword">unsigned</span> argc <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Value<span class="token operator">></span> argv<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Function<span class="token operator">></span> cons <span class="token operator">=</span> Local<span class="token operator">&lt;</span>Function<span class="token operator">></span><span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Context<span class="token operator">></span> context <span class="token operator">=</span> isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> instance <span class="token operator">=</span>
      cons<span class="token operator">-</span><span class="token operator">></span><span class="token function">NewInstance</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyObject<span class="token operator">::</span><span class="token function">PlusOne</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  MyObject<span class="token operator">*</span> obj <span class="token operator">=</span> ObjectWrap<span class="token operator">::</span>Unwrap<span class="token operator">&lt;</span>MyObject<span class="token operator">></span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">Holder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  obj<span class="token operator">-</span><span class="token operator">></span>value_ <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>Number<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> obj<span class="token operator">-</span><span class="token operator">></span>value_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// namespace demo</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同样，要构建这个示例，必须将 myobject.cc 文件添加到 binding.gyp：</p>
<pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"targets"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"target_name"</span><span class="token operator">:</span> <span class="token string">"addon"</span><span class="token punctuation">,</span>
      <span class="token property">"sources"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"addon.cc"</span><span class="token punctuation">,</span>
        <span class="token string">"myobject.cc"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试它：</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// test.js</span>
<span class="token keyword">const</span> createObject <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">plusOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Prints: 11</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">plusOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Prints: 12</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">plusOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Prints: 13</span>

<span class="token keyword">const</span> obj2 <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj2<span class="token punctuation">.</span><span class="token function">plusOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Prints: 21</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj2<span class="token punctuation">.</span><span class="token function">plusOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Prints: 22</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj2<span class="token punctuation">.</span><span class="token function">plusOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Prints: 23</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="传递包装对象"><a href="#传递包装对象" class="headerlink" title="传递包装对象"></a>传递包装对象</h3><p>除了包装和返回 C++ 对象之外，还可以通过使用 Node.js 辅助函数 node::ObjectWrap::Unwrap 来展开包装的对象来传递它们。以下示例显示了一个函数 add()，它可以将两个 MyObject 对象作为输入参数：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// addon.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node_object_wrap.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"myobject.h"</span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">using</span> v8<span class="token operator">::</span>Context<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Isolate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Number<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>String<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Value<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">CreateObject</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  MyObject<span class="token operator">::</span><span class="token function">NewInstance</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Context<span class="token operator">></span> context <span class="token operator">=</span> isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  MyObject<span class="token operator">*</span> obj1 <span class="token operator">=</span> node<span class="token operator">::</span>ObjectWrap<span class="token operator">::</span>Unwrap<span class="token operator">&lt;</span>MyObject<span class="token operator">></span><span class="token punctuation">(</span>
      args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">ToObject</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  MyObject<span class="token operator">*</span> obj2 <span class="token operator">=</span> node<span class="token operator">::</span>ObjectWrap<span class="token operator">::</span>Unwrap<span class="token operator">&lt;</span>MyObject<span class="token operator">></span><span class="token punctuation">(</span>
      args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">ToObject</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">double</span> sum <span class="token operator">=</span> obj1<span class="token operator">-</span><span class="token operator">></span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> obj2<span class="token operator">-</span><span class="token operator">></span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>Number<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> sum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">InitAll</span><span class="token punctuation">(</span>Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  MyObject<span class="token operator">::</span><span class="token function">Init</span><span class="token punctuation">(</span>exports<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">NODE_SET_METHOD</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">"createObject"</span><span class="token punctuation">,</span> CreateObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">NODE_SET_METHOD</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">"add"</span><span class="token punctuation">,</span> Add<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE</span><span class="token punctuation">(</span>NODE_GYP_MODULE_NAME<span class="token punctuation">,</span> InitAll<span class="token punctuation">)</span>

<span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// namespace demo</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 myobject.h 中，添加了一个新的公共方法以允许在展开对象后访问私有值。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// myobject.h</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> MYOBJECT_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MYOBJECT_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node_object_wrap.h></span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">class</span> <span class="token class-name">MyObject</span> <span class="token operator">:</span> <span class="token keyword">public</span> node<span class="token operator">::</span>ObjectWrap <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span>v8<span class="token operator">::</span>Isolate<span class="token operator">*</span> isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">NewInstance</span><span class="token punctuation">(</span><span class="token keyword">const</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">inline</span> <span class="token keyword">double</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> value_<span class="token punctuation">;</span> <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">explicit</span> <span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token keyword">double</span> value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">~</span><span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token keyword">const</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> v8<span class="token operator">::</span>Global<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Function<span class="token operator">></span> constructor<span class="token punctuation">;</span>
  <span class="token keyword">double</span> value_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// namespace demo</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>myobject.cc 的实现与之前类似：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// myobject.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"myobject.h"</span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">using</span> node<span class="token operator">::</span>AddEnvironmentCleanupHook<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Context<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Function<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionTemplate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Global<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Isolate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>String<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Value<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Warning! This is not thread-safe, this addon cannot be used for worker</span>
<span class="token comment" spellcheck="true">// threads.</span>
Global<span class="token operator">&lt;</span>Function<span class="token operator">></span> MyObject<span class="token operator">::</span>constructor<span class="token punctuation">;</span>

MyObject<span class="token operator">::</span><span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token keyword">double</span> value<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">value_</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

MyObject<span class="token operator">::</span><span class="token operator">~</span><span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyObject<span class="token operator">::</span><span class="token function">Init</span><span class="token punctuation">(</span>Isolate<span class="token operator">*</span> isolate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// Prepare constructor template</span>
  Local<span class="token operator">&lt;</span>FunctionTemplate<span class="token operator">></span> tpl <span class="token operator">=</span> FunctionTemplate<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> New<span class="token punctuation">)</span><span class="token punctuation">;</span>
  tpl<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetClassName</span><span class="token punctuation">(</span>String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> <span class="token string">"MyObject"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tpl<span class="token operator">-</span><span class="token operator">></span><span class="token function">InstanceTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">SetInternalFieldCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  Local<span class="token operator">&lt;</span>Context<span class="token operator">></span> context <span class="token operator">=</span> isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  constructor<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> tpl<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetFunction</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">AddEnvironmentCleanupHook</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    constructor<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyObject<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Context<span class="token operator">></span> context <span class="token operator">=</span> isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">IsConstructCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Invoked as constructor: `new MyObject(...)`</span>
    <span class="token keyword">double</span> value <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">IsUndefined</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span>
        <span class="token number">0</span> <span class="token operator">:</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">NumberValue</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FromMaybe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MyObject<span class="token operator">*</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">MyObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    obj<span class="token operator">-</span><span class="token operator">></span><span class="token function">Wrap</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">This</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">This</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Invoked as plain function `MyObject(...)`, turn into construct call.</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> argc <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    Local<span class="token operator">&lt;</span>Value<span class="token operator">></span> argv<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    Local<span class="token operator">&lt;</span>Function<span class="token operator">></span> cons <span class="token operator">=</span> Local<span class="token operator">&lt;</span>Function<span class="token operator">></span><span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> instance <span class="token operator">=</span>
        cons<span class="token operator">-</span><span class="token operator">></span><span class="token function">NewInstance</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyObject<span class="token operator">::</span><span class="token function">NewInstance</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token keyword">unsigned</span> argc <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Value<span class="token operator">></span> argv<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Function<span class="token operator">></span> cons <span class="token operator">=</span> Local<span class="token operator">&lt;</span>Function<span class="token operator">></span><span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Context<span class="token operator">></span> context <span class="token operator">=</span> isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Object<span class="token operator">></span> instance <span class="token operator">=</span>
      cons<span class="token operator">-</span><span class="token operator">></span><span class="token function">NewInstance</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// namespace demo</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试它：</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// test.js</span>
<span class="token keyword">const</span> addon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> obj1 <span class="token operator">=</span> addon<span class="token punctuation">.</span><span class="token function">createObject</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> obj2 <span class="token operator">=</span> addon<span class="token punctuation">.</span><span class="token function">createObject</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> addon<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj1<span class="token punctuation">,</span> obj2<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Prints: 30</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
        </div>
        
<blockquote class="copyright">
    <p><strong>本文链接 : </strong><a class="permalink" href="https://keyboard3.github.io/nodejs-addons/">https://keyboard3.github.io/nodejs-addons/</a></p>
    <p><strong>This article is available under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)</a> License</strong></p>
</blockquote>


    </article>
    
    <section id="comments">
        
            <div id="vcomments"></div>
        
    </section>


    

</main>


<aside style="" id="sidebar" class="aside aside-fixture">
    <div class="toc-sidebar">
        <nav id="toc" class="article-toc">
            <h3 class="toc-title">文章目录</h3>
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#C-Addons-插件"><span class="toc-number">1.</span> <span class="toc-text">C++ Addons(插件)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Hello-world"><span class="toc-number">1.1.</span> <span class="toc-text">Hello world</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#上下文感知插件"><span class="toc-number">1.1.1.</span> <span class="toc-text">上下文感知插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#支持-Worker"><span class="toc-number">1.1.2.</span> <span class="toc-text">支持 Worker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#构建"><span class="toc-number">1.1.3.</span> <span class="toc-text">构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#链接到-Node-js-中包含的库"><span class="toc-number">1.1.4.</span> <span class="toc-text">链接到 Node.js 中包含的库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-require-加载插件"><span class="toc-number">1.1.5.</span> <span class="toc-text">使用 require() 加载插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Node-js-的-Native-抽象"><span class="toc-number">1.1.6.</span> <span class="toc-text">Node.js 的 Native 抽象</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Node-API"><span class="toc-number">1.2.</span> <span class="toc-text">Node-API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#插件示例"><span class="toc-number">1.3.</span> <span class="toc-text">插件示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#函数参数"><span class="toc-number">1.3.1.</span> <span class="toc-text">函数参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回调"><span class="toc-number">1.3.2.</span> <span class="toc-text">回调</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#对象工厂"><span class="toc-number">1.3.3.</span> <span class="toc-text">对象工厂</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#函数工厂"><span class="toc-number">1.3.4.</span> <span class="toc-text">函数工厂</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#包装-C-对象"><span class="toc-number">1.3.5.</span> <span class="toc-text">包装 C++ 对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#对象包装工厂"><span class="toc-number">1.3.6.</span> <span class="toc-text">对象包装工厂</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#传递包装对象"><span class="toc-number">1.3.7.</span> <span class="toc-text">传递包装对象</span></a></li></ol></li></ol></li></ol>
        </nav>
    </div>
</aside>





        </section>
        <footer class="hidden lg:block fixed bottom-0 left-0 sm:w-1/12 lg:w-1/6 bg-gray-100 z-40">
    
    <div class="footer-social-links">
        
            <a href="https://github.com/keyboard3" target="_blank" rel="noopener">
                <i class="iconfont icon-github"></i>
            </a>
        
            <a href="/blog/atom.xml">
                <i class="iconfont icon-rss"></i>
            </a>
        
    </div>
    
    
        <p class="footer-custom">浙ICP备2022008282号</p>
        <p class="theme-brand">Theme by <a href="https://github.com/fengkx/hexo-theme-purer" target="_blank" rel="nofollow noopener noreferrer noopener">hexo-theme-purer</a></p>
    
</footer>

        <div id="mask" class="hidden mask fixed inset-0 bg-gray-900 opacity-75 z-40"></div>
        <div id="search-view-container" class="hidden shadow-xl"></div>
        
<script src="/blog/js/dom-event.min.js"></script>



<script src="/blog/js/local-search.min.js"></script>


    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//cdn.jsdelivr.net/npm/valine"></script>
<script type="text/javascript">
var GUEST = ['nick', 'mail', 'link'];
var meta = '';
meta = meta.split(',').filter(function(item) {
  return GUEST.indexOf(item) > -1;
});
new Valine({
  el: '#vcomments',
  verify: 'false',
  notify: 'false',
  appId: '',
  appKey: '',
  placeholder: 'just go go',
  avatar: 'mm',
  meta: meta,
  pageSize: '10' || 10,
  visitor: 'true',
  lang: ''
});
</script>



    <script src="//cdn.jsdelivr.net/npm/lightgallery.js@1.1.3/dist/js/lightgallery.min.js"></script>
    
<script src="/blog/js/light-gallery.min.js"></script>






    </body>
</html>
